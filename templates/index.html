<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Keuangan Pribadi</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body class="bg-gradient-to-r from-blue-50 to-indigo-50 min-h-screen font-sans text-gray-800">
    <div class="container mx-auto p-6">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">Dashboard Keuangan Pribadi</h1>
            <p class="text-xl text-indigo-900">Saldo Anda: <span class="font-mono text-2xl">Rp {{ "{:,.2f}".format(saldo) }}</span></p>
        </header>

        <!-- Filter Bulan/Tahun -->
        <form method="GET" class="mb-6 flex flex-wrap justify-center gap-4 items-end">
            <div class="w-32">
                <label for="bulan" class="block text-sm font-semibold mb-1">Bulan</label>
                <select name="bulan" id="bulan" class="w-full rounded-md border border-indigo-300 px-3 py-2 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    {% for i in range(1, 13) %}
                    <option value="{{ i }}" {% if i == bulan %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="w-32">
                <label for="tahun" class="block text-sm font-semibold mb-1">Tahun</label>
                <input type="number" name="tahun" id="tahun" value="{{ tahun }}" class="w-full rounded-md border border-indigo-300 px-3 py-2 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-md px-6 py-2 shadow-md transition">Filter</button>
            </div>
        </form>

        <!-- Tombol Aksi -->
        <div class="mb-8 flex flex-wrap justify-center gap-4">
            <a href="{{ url_for('tambah_transaksi') }}" class="btn-primary">Tambah Transaksi</a>
            <a href="{{ url_for('tambah_anggaran') }}" class="btn-green">Tambah Anggaran</a>
            <a href="{{ url_for('tambah_tabungan') }}" class="btn-purple">Tambah Target Tabungan</a>
            <a href="{{ url_for('ekspor_excel') }}" class="btn-gray">Ekspor ke Excel</a>
        </div>

        <!-- Visualisasi -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-indigo-700">Proporsi Pengeluaran</h3>
                <canvas id="pengeluaranChart" class="w-full h-60"></canvas>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-indigo-700">Tren Bulanan</h3>
                <canvas id="trenChart" class="w-full h-60"></canvas>
            </div>
        </section>

        <!-- Status Anggaran -->
        <section class="mb-10">
            <h3 class="text-xl font-semibold mb-4 text-indigo-700">Status Anggaran</h3>
            <div class="overflow-x-auto rounded-lg shadow-md bg-white">
                <table class="min-w-full divide-y divide-gray-200 table-auto">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-indigo-900">Kategori</th>
                            <th class="px-6 py-3 text-right text-sm font-semibold text-indigo-900">Batas</th>
                            <th class="px-6 py-3 text-right text-sm font-semibold text-indigo-900">Terpakai</th>
                            <th class="px-6 py-3 text-right text-sm font-semibold text-indigo-900">Sisa</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for a in anggaran_status %}
                        <tr class="{% if a.melebihi %}bg-red-50{% else %}hover:bg-indigo-50{% endif %} transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap font-medium">{{ a.kategori }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">Rp {{ "{:,.2f}".format(a.batas) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">Rp {{ "{:,.2f}".format(a.terpakai) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">Rp {{ "{:,.2f}".format(a.sisa) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Target Tabungan -->
        <section class="mb-10">
            <h3 class="text-xl font-semibold mb-4 text-indigo-700">Target Tabungan</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for t in tabungan %}
                <div class="bg-white rounded-lg shadow-md p-5 flex flex-col justify-between">
                    <div>
                        <h4 class="font-bold text-lg mb-2 text-indigo-800">{{ t.nama }}</h4>
                        <p><span class="font-semibold">Target:</span> Rp {{ "{:,.2f}".format(t.target) }}</p>
                        <p><span class="font-semibold">Terkumpul:</span> Rp {{ "{:,.2f}".format(t.terkumpul) }}</p>
                        <p><span class="font-semibold">Tenggat:</span> {{ t.tenggat }}</p>
                    </div>
                    <form method="POST" action="{{ url_for('tambah_dana_tabungan', id=t.id) }}" class="mt-4 flex space-x-2">
                        <input
                            type="number"
                            name="jumlah"
                            step="0.01"
                            placeholder="Tambah Dana"
                            class="flex-grow border border-indigo-300 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                        />
                        <button type="submit" class="btn-primary">Tambah</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Riwayat Transaksi -->
        <section>
            <h3 class="text-xl font-semibold mb-4 text-indigo-700">Riwayat Transaksi</h3>
            <div class="overflow-x-auto rounded-lg shadow-md bg-white">
                <table class="min-w-full divide-y divide-gray-200 table-auto">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-indigo-900 whitespace-nowrap">Tanggal</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-indigo-900 whitespace-nowrap">Deskripsi</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-indigo-900 whitespace-nowrap">Jumlah</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-indigo-900 whitespace-nowrap">Tipe</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-indigo-900 whitespace-nowrap">Kategori</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-indigo-900 whitespace-nowrap">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for t in transaksi %}
                        <tr class="hover:bg-indigo-50 transition-colors">
                            <td class="px-4 py-3 whitespace-nowrap">{{ t.tanggal }}</td>
                            <td class="px-4 py-3 whitespace-nowrap max-w-xs truncate" title="{{ t.deskripsi }}">{{ t.deskripsi }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-right">Rp {{ "{:,.2f}".format(t.jumlah) }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-center">{{ t.tipe.capitalize() }}</td>
                            <td class="px-4 py-3 whitespace-nowrap">{{ t.kategori }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-center">
                                <a
                                    href="{{ url_for('hapus_transaksi', id=t.id) }}"
                                    class="text-red-600 hover:text-red-800 font-semibold"
                                    onclick="return confirm('Yakin ingin menghapus transaksi ini?');"
                                    >Hapus</a
                                >
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // Chart Pengeluaran (Pie)
        try {
            const ctxPie = document.getElementById('pengeluaranChart').getContext('2d');
            const chartDataRaw = {{ chart_data | safe }};
            const chartData = {
                labels: chartDataRaw.labels || ['Makanan', 'Transportasi', 'Hiburan', 'Belanja', 'Lainnya'],
                data: chartDataRaw.data || [0, 0, 0, 0, 0]
            };
            new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.data,
                        backgroundColor: ['#EF4444', '#3B82F6', '#F59E0B', '#10B981', '#8B5CF6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 14 } } },
                        title: { display: true, text: 'Proporsi Pengeluaran per Kategori', font: { size: 18, weight: 'bold' } }
                    }
                }
            });
        } catch (e) {
            console.error('Error rendering pie chart:', e);
            document.getElementById('pengeluaranChart').style.display = 'none';
        }

        // Chart Tren Bulanan (Line)
        try {
            const ctxLine = document.getElementById('trenChart').getContext('2d');
            const trenDataRaw = {{ tren_data | safe }};
            const trenData = {
                labels: trenDataRaw.labels || [],
                pemasukan: trenDataRaw.pemasukan || [],
                pengeluaran: trenDataRaw.pengeluaran || []
            };
            new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: trenData.labels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: trenData.pemasukan,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.3)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Pengeluaran',
                            data: trenData.pengeluaran,
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.3)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 14 } } },
                        title: { display: true, text: 'Tren Pemasukan & Pengeluaran', font: { size: 18, weight: 'bold' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'Rp ' + value.toLocaleString()
                            }
                        }
                    }
                }
            });
        } catch (e) {
            console.error('Error rendering line chart:', e);
            document.getElementById('trenChart').style.display = 'none';
        }
    </script>

    <style>
        /* Custom button styles */
        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-md px-5 py-2 shadow-md transition;
        }
        .btn-green {
            @apply bg-green-600 hover:bg-green-700 text-white font-semibold rounded-md px-5 py-2 shadow-md transition;
        }
        .btn-purple {
            @apply bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md px-5 py-2 shadow-md transition;
        }
        .btn-gray {
            @apply bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-md px-5 py-2 shadow-md transition;
        }
    </style>
</body>
</html>
